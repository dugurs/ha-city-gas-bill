
# Home Assistant - 도시가스 요금 통합구성요소 (City Gas Bill)

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/hacs/integration)
[![LICENSE](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

한국 내 다양한 도시가스 공급사의 요금을 Home Assistant에서 자동으로 계산하고 추적하는 통합구성요소입니다. 가스 계량기 센서와 월 검침일(및 검침시간)만 설정하면, 웹사이트에서 최신 단가와 열량 정보를 가져와 현재까지의 사용 요금 및 월 예상 요금을 정밀하게 계산하여 제공합니다.

## 주요 기능

-   **정밀한 요금 계산**: 검침일이 월의 중간일 경우, 지난달과 이번 달의 요금제를 사용 일수에 비례하여 배분(일할 계산)하여 정확한 요금을 계산합니다.
-   **취사/난방 요금 분리 적용**: 대부분의 공급사가 제공하는 저렴한 '취사' 단가와 비싼 '난방' 단가를 분리하여 계산합니다. 사용자가 설정한 '취사난방경계(MJ)'까지는 취사 단가를, 초과분에 대해서는 난방 단가를 적용하여 요금 정확도를 높였습니다.
-   **유연한 검침 주기 지원**: `매월` 검침뿐_만 아니라, `격월(홀수월)` 또는 `격월(짝수월)` 검침 주기를 완벽하게 지원합니다. 격월 주기 선택 시, 2달치 사용량과 요금을 합산하여 보여주는 전용 센서들이 자동으로 추가됩니다.
-   **확장 가능한 프로바이더 구조**: 플러그인 방식으로 각 지역 도시가스 공급사를 쉽게 추가할 수 있습니다.
-   **수동 입력 모드 지원**: 스크래핑을 지원하지 않는 지역의 사용자도 '수동 입력' 프로바이더를 선택하여 직접 단가와 열량 정보를 입력하고 요금 계산 기능을 사용할 수 있습니다.
-   **자동 월 주기 리셋**: 매월 설정된 검침일과 검침시간이 동시에 도달하면, 현재까지의 요금은 '전월 요금'으로 기록되고, 월 사용량은 자동으로 초기화되어 새로운 달의 계산을 시작합니다.
-   **예상 요금 및 사용량 제공**: 현재까지의 사용 패턴을 분석하여 이번 달의 총 예상 사용량과 예상 요금을 미리 확인할 수 있습니다.
-   **온압보정계수 지원**: 고지서에 온압보정계수가 적용되는 경우, 해당 값을 직접 입력하여 더욱 정확한 요금을 계산할 수 있습니다.
*   **자동 데이터 동기화**:
    *   매주 월요일 새벽 1시에 도시가스 웹사이트에서 **열량단가**를 자동으로 가져와 업데이트합니다.
    *   매일 설정된 검침시간 5분 전에 도시가스 웹사이트에서 **평균열량**을 자동으로 가져와 업데이트합니다.
-   **수동 데이터 동기화**: UI의 버튼과 별도의 서비스를 통해 원할 때 언제든지 최신 데이터로 동기화할 수 있습니다.

## 지원되지 않는 기능

이 통합구성요소는 가스 사용량에 따른 **표준 요금**을 계산하는 것을 목표로 합니다. 따라서 실제 고지서에 포함될 수 있는 아래와 같은 각종 할인 및 추가 비용은 계산에 **반영되지 않습니다.** (단, 동절기/비동절기 경감액은 지원)

-   사회적 배려 대상자 할인 (장애인, 기초생활수급자 등)
-   자동이체 할인, 전자고지서 할인
-   체납 가산금 또는 기타 비정기적 비용

이로 인해 센서에 표시되는 값과 실제 청구서의 최종 금액은 다를 수 있습니다.

## 지원되는 공급사

| 공급사 ID (`id`) | 이름 | 지원 지역 | 중앙난방 |
| :--- | :--- | :--- | :--- |
| `seoul_gas` | 서울도시가스 | 서울, 경기 | ❌ |
| `incheon_gas` | 인천도시가스(코원) | 인천, 경기 | ✅ |
| `yesco_gas` | 예스코 | 서울, 경기 | ❌ |
| `koone_gas` | 코원에너지서비스 (SK E&S) | 서울, 경기 | ❌ |
| `busan_gas` | 부산도시가스 (SK E&S) | 부산 | ✅ |
| `kiturami_gas` | 귀뚜라미에너지 | 서울 | ❌ |
| `manual` | 수동 입력 (직접 관리) | 모든 지역 | N/A |

## 설치 방법

### HACS (Home Assistant Community Store)를 통한 설치 (권장)

1.  HACS > 통합구성요소(Integrations) 페이지로 이동합니다.
2.  우측 상단의 점 3개 메뉴를 클릭하고 **'커스텀 저장소 (Custom repositories)'**를 선택합니다.
3.  저장소 URL 입력란에 아래 주소를 붙여넣습니다.
    ```
    https://github.com/dugurs/ha-city-gas-bill
    ```
4.  카테고리를 **'통합구성요소 (Integration)'**로 선택하고 **'추가 (ADD)'** 버튼을 누릅니다.
5.  새로 추가된 "City Gas Bill" 카드를 찾아 **'설치 (INSTALL)'** 버튼을 누르고, 다운로드를 진행합니다.
6.  Home Assistant를 재시작합니다.

### 수동 설치

1.  GitHub 저장소의 [Releases](https://github.com/dugurs/ha-city-gas-bill/releases) 페이지에서 최신 버전을 다운로드합니다.
2.  압축을 해제한 뒤, `city_gas_bill` 폴더 전체를 Home Assistant 설정 폴더 아래의 `custom_components` 폴더로 복사합니다.
    (경로 예: `/config/custom_components/city_gas_bill`)
3.  Home Assistant를 재시작합니다.

## 설정 방법

1.  **설정 > 장치 및 서비스**로 이동합니다.
2.  우측 하단의 **통합구성요소 추가** 버튼을 클릭합니다.
3.  "**City Gas Bill**"을 검색하여 선택합니다.
4.  설정 창에 아래 정보를 입력합니다.
    -   **도시가스 공급사**: 드롭다운 목록에서 해당하는 지역의 공급사를 선택합니다. 지원 목록에 없는 경우 '수동 입력'을 선택하세요.
    -   **가스 용도**: '주택난방'과 '중앙난방' 중 본인에게 해당하는 용도를 선택합니다. (선택한 공급사가 중앙난방을 지원하지 않는 경우 오류가 발생합니다.)
    -   **가스 사용량 센서 (m³)**: 현재 가스 누적 사용량을 나타내는 `sensor` 엔티티를 선택합니다. (예: `sensor.gas_meter`)
    -   **월 정기 검침일**: 본인의 가스 요금 검침일을 입력합니다. 매월 말일이 검침일인 경우 **0**을 입력하세요.
    -   **월 정기 검침시간 (HH:MM)**: 리셋이 수행될 시각(현지시간)을 지정합니다. 검침일과 검침시간이 모두 일치해야 리셋이 실행됩니다.
    -   **검침 주기**: 본인의 요금 청구 주기를 `매월`, `격월 - 홀수월`, `격월 - 짝수월` 중에서 선택합니다. (기본값: 매월)
5.  **제출** 버튼을 누르면 설정이 완료되고, 관련 엔티티들이 자동으로 생성됩니다.

## 가스요금 계산 방식

이 통합구성요소는 실제 도시가스 고지서의 계산 방식을 최대한 유사하게 구현하여 정확도를 높였습니다.

### 계산에 사용되는 주요 값

| 변수 | 해당 엔티티 | 설명 |
| :--- | :--- | :--- |
| **계량기 사용량** | `sensor.monthly_gas_usage` | 현재 계량기 값 - 월 시작 계량기 값 |
| **온압보정계수** | `number.correction_factor` | 사용자가 입력한 온도/압력 보정 계수 |
| **기본요금** | `number.base_fee` | 월별 고정 부과 요금 |
| **전월/당월 평균열량** | `number.prev/curr_month_heat` | MJ/Nm³ 단위의 평균열량 |
| **전월/당월 열량단가** | `number.prev/curr_month_price_...` | KRW/MJ 단위의 취사/난방 열량단가 |
| **취사난방경계** | `number.cooking_heating_boundary` | 취사/난방 요금 분리의 기준이 되는 월 사용 열량(MJ), 기본값0, 분리계산의 경우 수기 수정!, 보통 516MJ |
| **동절기/비동절기 경감액** | `number.winter/non_winter_reduction_fee` | 계절에 따라 적용되는 월별 경감액 |

### 계산 단계

1.  **보정 사용량 계산**: 실제 요금 청구의 기준이 되는 사용량을 계산합니다.
    > **보정 사용량 (Nm³)** = `계량기 사용량 (m³)` × `온압보정계수`

2.  **사용량 일할 배분**: '보정 사용량'을 검침 기간 동안의 **전월 일수**와 **당월 일수** 비율에 따라 나눕니다.
    > **전월분 사용량** = `보정 사용량` × (`전월 일수` / `총 사용일수`)
    > **당월분 사용량** = `보정 사용량` × (`당월 일수` / `총 사용일수`)

3.  **열량 변환 및 취사/난방 분리 (조건부)**
    이 단계는 `취사난방경계` 값에 따라 다르게 동작합니다.

    -   **Case 1: `취사난방경계`가 0일 경우 (기본값)**
        -   모든 사용량은 **난방용**으로 간주됩니다.
        -   계산된 `전월분/당월분 사용량`에 각 월의 `평균열량`과 **`난방 열량단가`**만을 곱하여 요금을 계산합니다. (아래 4단계로 바로 진행)

    -   **Case 2: `취사난방경계`가 0보다 클 경우**
        -   사용량을 취사용과 난방용으로 분리합니다.
        -   먼저 각 월별로 배분된 사용량(Nm³)을 열량(MJ)으로 변환합니다.
            > **전월 총 사용열량 (MJ)** = `전월분 사용량` × `전월 평균열량`
        -   그 다음, `취사난방경계` 값을 일할 계산하여 해당 월의 취사 한도를 정하고, 사용 열량을 취사용과 난방용으로 분리합니다.
            > **전월 취사열량** = min(`전월 총 사용열량`, `취사난방경계` × (`전월 일수` / `총 사용일수`))
            > **전월 난방열량** = `전월 총 사용열량` - `전월 취사열량`
            > (당월도 동일한 방식으로 계산)

4.  **월별 요금 및 경감액 계산**: 분리된 열량(또는 전체 난방 열량)에 각 월, 각 용도에 맞는 단가를 곱하고, 해당 월의 경감액을 일할 적용합니다.
    - 전월이 동절기(12~3월)에 해당하면 '동절기 경감액'을, 아니면 '동절기외 경감액'을 사용합니다. 당월도 동일하게 적용됩니다.
    - **중요**: 일할 계산된 경감액은 해당 월의 사용요금을 초과할 수 없습니다.
    > **전월분 취사용금** = `전월 취사열량` × `전월 취사단가`
    > **전월분 난방요금** = `전월 난방열량` × `전월 난방단가`
    > **전월분 사용요금** = `전월분 취사용금` + `전월분 난방요금`
    >
    > **전월분 적용 경감액** = min(`전월분 사용요금`, `해당월 경감액` × (`전월 일수` / `총 사용일수`))
    > (당월도 동일한 방식으로 계산)

5.  **최종 청구 요금**: 모든 요금을 합산하고, 부가가치세(10%)를 더한 뒤, **10원 미만을 버립니다.**
    > **최종 요금** = floor( (`기본요금` + `전월분 사용요금` - `전월분 적용 경감액` + `당월분 사용요금` - `당월분 적용 경감액`) × 1.1 / 10 ) * 10

## 제공되는 엔티티 및 서비스

설치가 완료되면 하나의 장치(Device) 아래에 다음과 같은 엔티티와 서비스가 생성됩니다.

#### 센서 (Sensor) - 기본

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **월 가스 사용량** | 현재 검침 주기(1달) 동안의 누적 가스 사용량(m³)입니다. |
| **월 사용 요금** | 현재 검침 주기(1달) 동안의 실시간 누적 요금입니다. |
| **월 예상 사용량** | 현재 사용 패턴을 기반으로 계산된 이번 달의 최종 예상 사용량(m³)입니다. |
| **월 예상 요금** | 현재 사용 패턴을 기반으로 계산된 이번 달의 최종 예상 요금입니다. |
| **전월 사용 요금** | 지난달 검침 주기의 최종 확정 요금입니다. |
| **마지막 동기화 성공** | 공급사 웹사이트에서 데이터를 성공적으로 가져온 마지막 시간입니다. |

#### 센서 (Sensor) - 격월 주기 전용

설정에서 '검침 주기'를 `격월`로 선택한 경우에만 아래의 센서들이 **추가로 생성**됩니다.

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **격월 가스 사용량** | 현재 청구 주기(최대 2달) 동안의 누적 가스 사용량입니다. |
| **격월 사용 요금** | 현재 청구 주기(최대 2달) 동안의 누적 요금입니다. |
| **격월 예상 사용량** | 지난달 실제 사용량과 이번 달 예상 사용량을 합산한 2달치 총 예상 사용량입니다. |
| **격월 예상 요금** | 지난달 실제 요금과 이번 달 예상 요금을 합산한 2달치 총 예상 요금입니다. |
| **격월 직전 사용 요금**| 지난 격월 주기의 최종 확정 요금(2달치 합산)입니다. |

#### 숫자 (Number)

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **기본요금** | 월별로 부과되는 기본요금입니다. (기본값: 1250원) |
| **월검침시작값** | 이번 달 요금 계산이 시작된 시점의 가스 계량기 값(소수부)입니다. 리셋 시 현재 계량값의 소수부만 저장합니다. |
| **전월/당월 평균열량**| 요금 계산에 사용되는 MJ/Nm³ 단위의 평균열량입니다. (자동 또는 수동 설정) |
| **전월/당월 열량단가(취사/난방)**| 요금 계산에 사용되는 KRW/MJ 단위의 열량단가입니다. (자동 또는 수동 설정) |
| **온압보정계수** | 가스 부피 보정에 사용되는 계수입니다. (기본값: 1.0, 필요시 수정) |
| **취사난방경계** | 취사 요금을 적용할 월 최대 열량(MJ)입니다. 이 값을 초과하면 난방 요금이 적용됩니다. **(기본값: 0, 0이면 모든 사용량에 난방 단가가 적용됩니다.)** |
| **동절기 경감액** | 동절기(12~3월)에 적용되는 월별 경감액입니다. 일할 계산됩니다. (기본값: 0) |
| **동절기외 경감액** | 비동절기(4~11월)에 적용되는 월별 경감액입니다. 일할 계산됩니다. (기본값: 0) |

#### 버튼 (Button)

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **열량단가 갱신** | 버튼을 누르면 즉시 공급사 웹사이트에서 최신 **열량단가** 데이터를 가져옵니다. |
| **평균열량 갱신** | 버튼을 누르면 즉시 공급사 웹사이트에서 최신 **평균열량** 데이터를 가져옵니다. |
| **기본요금 갱신** | 버튼을 누르면 즉시 공급사 웹사이트에서 최신 **기본요금** 데이터를 가져옵니다. |

#### 서비스 (Service)

| 서비스 이름 | 설명 |
| :--- | :--- |
| `city_gas_bill.update_price_data` | **'열량단가 갱신'** 버튼을 누르는 것과 동일한 작업을 수행합니다. 매주 월요일 1시에 자동실행 됩니다. 자동화(Automation)나 스크립트(Script)에서 이 서비스를 호출하여 원하는 시점에 **열량단가**를 강제로 갱신할 수 있습니다. |
| `city_gas_bill.update_heat_data` | **'평균열량 갱신'** 버튼을 누르는 것과 동일한 작업을 수행합니다. 매일 검침시간 5분전에 자동실행 됩니다. 자동화(Automation)나 스크립트(Script)에서 이 서비스를 호출하여 원하는 시점에 **평균열량**을 강제로 갱신할 수 있습니다. |
| `city_gas_bill.update_base_fee` | **'기본요금 갱신'** 버튼을 누르는 것과 동일한 작업을 수행합니다. 공급사 웹사이트에서 최신 **기본요금** 데이터를 가져와 업데이트합니다. 구성 등록변경시 자동실행 됩니다. |

#### 센서 속성 (상세 정보)

`월 사용 요금` 및 `월 예상 요금` 센서를 클릭하여 상세 정보(Attributes)를 확인하면, 요금 계산에 사용된 모든 변수와 중간 계산 결과를 볼 수 있습니다. 이는 요금이 어떻게 계산되었는지 투명하게 보여주며, 문제 해결이나 고급 자동화(Automation)에 유용하게 활용될 수 있습니다.

| 속성 키 (Attribute) | 설명 |
| :--- | :--- |
| `start_date` | 현재 요금 계산 기간의 시작일입니다. |
| `end_date` | 현재 요금 계산 기간의 종료일입니다. (`월 예상 요금` 센서에서는 다음 검침 예정일이 표시됩니다.) |
| `days_total` | 총 사용일수입니다. |
| `days_prev_month` | 총 사용일수 중 전월에 해당하는 일수입니다. |
| `days_curr_month` | 총 사용일수 중 당월에 해당하는 일수입니다. |
| `base_fee` | 계산에 적용된 기본요금입니다. |
| `monthly_gas_usage` | 온압보정계수 적용 전, 계량기 기준 월 사용량(m³)입니다. (`월 예상 요금`에서는 예상 사용량입니다.) |
| `correction_factor` | 계산에 적용된 온압보정계수입니다. |
| `corrected_monthly_usage` | 온압보정계수가 적용된 청구 기준 사용량(Nm³)입니다. (`월 예상 요금`에서는 예상 사용량 기준입니다.) |
| `cooking_heating_boundary` | 계산에 적용된 취사/난방 경계(MJ)입니다. |
| `prev_month_calculated_fee` | 전월 기간에 대해 계산된 총 사용요금입니다. (경감액 적용 전) |
| `curr_month_calculated_fee` | 당월 기간에 대해 계산된 총 사용요금입니다. (경감액 적용 전) |
| `prev_month_reduction_applied` | 전월 기간에 최종 적용된 경감액입니다. |
| `curr_month_reduction_applied` | 당월 기간에 최종 적용된 경감액입니다. |
| `prev_month_cooking_fee` | 전월 기간에 대해 계산된 취사 요금입니다. (`취사난방경계` 설정 시) |
| `prev_month_heating_fee` | 전월 기간에 대해 계산된 난방 요금입니다. |
| `curr_month_cooking_fee` | 당월 기간에 대해 계산된 취사 요금입니다. (`취사난방경계` 설정 시) |
| `curr_month_heating_fee` | 당월 기간에 대해 계산된 난방 요금입니다. |

## 사용 가이드

### 데이터 동기화

-   **열량단가** 데이터는 **매주 월요일 새벽 1시**에 자동으로 동기화됩니다.
-   **평균열량** 데이터는 설정된 **검침시간 30분 전**에 매일 자동으로 동기화됩니다.
-   즉시 동기화가 필요한 경우, 해당되는 **갱신 버튼**을 누르거나 해당 서비스를 호출하세요.

### 수동 입력 모드 사용법

1.  설정 시 공급사로 **'수동 입력 (직접 관리)'**를 선택합니다.
2.  엔티티가 생성되면, 본인의 가스 요금 고지서를 참고하여 아래 `Number` 엔티티들의 값을 직접 수정합니다.
    -   기본요금
    -   전월/당월 평균열량
    -   전월/당월 열량단가 (취사/난방)
    -   온압보정계수 (필요시)
    -   취사난방경계 (필요시)
    -   동절기/동절기외 경감액 (필요시)
3.  값을 수정한 후부터 정확한 요금이 계산됩니다. '데이터 동기화' 버튼은 수동 모드에서는 엔티티 값을 변경하지 않습니다.

### 청구 주기 리셋 로직

-   사용자가 설정한 **'월 정기 검침일'과 '월 정기 검침시간'**이 동시에 일치할 때, 다음 작업을 수행합니다.
    1.  전월요금 이관 시, 전월 사용량을 **소수점 버림한 정수 사용량**으로 다시 계산하여 `전월 사용 요금` 센서에 저장합니다.
    2.  `월검침시작값`을 현재 계량기 값의 **소수부(현재값 - 정수부)**로 설정해, 새 주기의 사용량 계산이 정수 경계 기준으로 시작되도록 합니다.
    3.  이후 새 주기의 요금/사용량 계산이 진행됩니다.

## 최근 변경 사항

-   **취사/난방 요금 분리 기능 추가**: `취사난방경계` Number 엔티티를 추가하여, 사용량에 따라 다른 단가를 적용하도록 계산 로직을 개선했습니다.
-   **서비스 분리**: `city_gas_bill.update_data` 서비스가 `city_gas_bill.update_price_data` (열량단가 갱신)와 `city_gas_bill.update_heat_data` (평균열량 갱신)로 분리되었습니다.
-   자동 갱신 주기 변경: 열량단가는 매주 월요일 새벽 1시, 평균열량은 매일 검침시간 5분 전에 갱신됩니다.
-   버튼 추가: '열량단가 갱신'과 '평균열량 갱신' 버튼이 추가되어 사용자가 원하는 데이터를 선택적으로 갱신할 수 있습니다.
-   공통 계산 클래스 `GasBillCalculator` 도입: 월/예상/격월 요금 계산 로직을 중앙집중화.
-   격월 센서 로직 정리: 합산 여부/집계를 공통 메서드로 통일.
-   전월요금 이관 시 정수 사용량 기반 재계산 적용.
-   리셋 시 `월검침시작값`을 현재 계량값의 소수부로 저장하도록 변경.
-   옵션에 **월 정기 검침시간 (HH:MM)** 추가, 리셋 조건을 “검침일 AND 검침시간”으로 강화.
-   **동절기/비동절기 경감액 기능 추가**: 계절별 경감액을 일할 계산하여 요금에 반영.
-   **최종 요금 10원 단위 절사**: 실제 고지서와 유사하게 최종 요금의 10원 미만 금액을 버림 처리.

## 새로운 공급사 추가하기 (고급)

이 통합구성요소는 새로운 도시가스 공급사를 쉽게 추가할 수 있도록 설계되었습니다.

1.  `custom_components/city_gas_bill/providers/` 폴더 안에 새로운 파이썬 파일(`busan_gas.py` 등)을 생성합니다.
2.  `providers/base.py`의 `GasProvider`를 상속받는 클래스를 작성하고, 스크래핑 로직을 구현합니다.
3.  Home Assistant를 재시작하면, 설정 화면의 공급사 목록에 새로 추가한 프로바이더가 자동으로 나타납니다.

## 참고 주소

- [도시가스협회 - 도시가스회사 현황](http://www.citygas.or.kr/company/situation.jsp)

## 라이선스

이 프로젝트는 [MIT 라이선스](LICENSE)에 따라 배포됩니다.