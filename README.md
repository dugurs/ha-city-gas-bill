# Home Assistant - 도시가스 요금 통합구성요소 (City Gas Bill)

[![hacs_badge](https://img.shields.io/badge/HACS-Custom-orange.svg)](https://github.com/hacs/integration)
[![LICENSE](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)

한국 내 다양한 도시가스 공급사의 요금을 Home Assistant에서 자동으로 계산하고 추적하는 통합구성요소입니다. 가스 계량기 센서와 월 검침일만 설정하면, 웹사이트에서 최신 단가와 열량 정보를 가져와 현재까지의 사용 요금 및 월 예상 요금을 정밀하게 계산하여 제공합니다.

## 주요 기능

-   **정밀한 요금 계산**: 검침일이 월의 중간일 경우, 지난달과 이번 달의 요금제를 사용 일수에 비례하여 배분하여 정확한 요금을 계산합니다.
-   **확장 가능한 프로바이더 구조**: 플러그인 방식으로 각 지역 도시가스 공급사를 쉽게 추가할 수 있습니다. (현재 서울, 인천, 경기 지원)
-   **수동 입력 모드 지원**: 스크래핑을 지원하지 않는 지역의 사용자도 '수동 입력' 프로바이더를 선택하여 직접 단가와 열량 정보를 입력하고 요금 계산 기능을 사용할 수 있습니다.
-   **자동 월 주기 리셋**: 매월 설정된 검침일이 되면, 현재까지의 요금은 '전월 요금'으로 기록되고, 월 사용량은 자동으로 초기화되어 새로운 달의 계산을 시작합니다.
-   **예상 요금 및 사용량 제공**: 현재까지의 사용 패턴을 분석하여 이번 달의 총 예상 사용량과 예상 요금을 미리 확인할 수 있습니다.
-   **온압보정계수 지원**: 고지서에 온압보정계수가 적용되는 경우, 해당 값을 직접 입력하여 더욱 정확한 요금을 계산할 수 있습니다.
*   **자동 데이터 동기화**: 매주 월요일 새벽 1시에 서울도시가스 웹사이트에서 평균열량 및 열량단가를 자동으로 가져와 업데이트합니다.
-   **수동 데이터 동기화**: UI의 버튼과 별도의 서비스를 통해 원할 때 언제든지 최신 데이터로 동기화할 수 있습니다.

## 지원되는 공급사

| 공급사 ID (`id`) | 이름 | 데이터 소스 |
| :--- | :--- | :--- |
| `seoul_gas` | 서울도시가스 | 웹사이트 스크래핑 (자동) |
| `incheon_gas` | 인천도시가스 (인천, 코원에너지) | 웹사이트 스크래핑 (자동) |
| `gyeonggi_gas` | 인천도시가스 (경기, 코원에너지) | 웹사이트 스크래핑 (자동) |
| `manual` | 수동 입력 (직접 관리) | 사용자 직접 입력 (수동) |

## 설치 방법

### HACS (Home Assistant Community Store)를 통한 설치 (권장)

1.  HACS > 통합구성요소(Integrations) 페이지로 이동합니다.
2.  우측 상단의 점 3개 메뉴를 클릭하고 **'커스텀 저장소 (Custom repositories)'**를 선택합니다.
3.  저장소 URL 입력란에 아래 주소를 붙여넣습니다.
    ```
    https://github.com/dugurs/ha-city-gas-bill
    ```
4.  카테고리를 **'통합구성요소 (Integration)'**로 선택하고 **'추가 (ADD)'** 버튼을 누릅니다.
5.  새로 추가된 "City Gas Bill" 카드를 찾아 **'설치 (INSTALL)'** 버튼을 누르고, 다운로드를 진행합니다.
6.  Home Assistant를 재시작합니다.

### 수동 설치

1.  GitHub 저장소의 [Releases](https://github.com/dugurs/ha-city-gas-bill/releases) 페이지에서 최신 버전을 다운로드합니다.
2.  압축을 해제한 뒤, `city_gas_bill` 폴더 전체를 Home Assistant 설정 폴더 아래의 `custom_components` 폴더로 복사합니다.
    (경로 예: `/config/custom_components/city_gas_bill`)
3.  Home Assistant를 재시작합니다.

## 설정 방법

1.  **설정 > 장치 및 서비스**로 이동합니다.
2.  우측 하단의 **통합구성요소 추가** 버튼을 클릭합니다.
3.  "**City Gas Bill**"을 검색하여 선택합니다.
4.  설정 창에 아래 정보를 입력합니다.
    -   **도시가스 공급사**: 드롭다운 목록에서 해당하는 지역의 공급사를 선택합니다. 지원 목록에 없는 경우 '수동 입력'을 선택하세요.
    -   **가스 사용량 센서 (m³)**: 현재 가스 누적 사용량을 나타내는 `sensor` 엔티티를 선택합니다. (예: `sensor.gas_meter`)
    -   **월 정기 검침일**: 본인의 가스 요금 검침일을 입력합니다. 매월 말일이 검침일인 경우 **0**을 입력하세요.
5.  **제출** 버튼을 누르면 설정이 완료되고, 관련 엔티티들이 자동으로 생성됩니다.

## 제공되는 엔티티 및 서비스

설치가 완료되면 하나의 장치(Device) 아래에 다음과 같은 엔티티와 서비스가 생성됩니다.

#### 센서 (Sensor)

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **총 사용요금** | 현재 검침 주기 동안의 실시간 누적 요금입니다. |
| **월 예상 요금** | 현재 사용 패턴을 기반으로 계산된 이번 달의 최종 예상 요금입니다. |
| **월 가스 사용량** | 현재 검침 주기 동안의 누적 가스 사용량(m³)입니다. |
| **월 예상 사용량** | 현재 사용 패턴을 기반으로 계산된 이번 달의 최종 예상 사용량(m³)입니다. |
| **전월 총 사용요금** | 지난달 검침 주기의 최종 확정 요금입니다. |
| **마지막 동기화 성공** | 공급사 웹사이트에서 데이터를 성공적으로 가져온 마지막 시간입니다. |

#### 숫자 (Number)

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **기본요금** | 월별로 부과되는 기본요금입니다. (기본값: 1250원) |
| **월검침시작값** | 이번 달 요금 계산이 시작된 시점의 가스 계량기 값입니다. |
| **전월/당월 평균열량** | 요금 계산에 사용되는 MJ/Nm³ 단위의 평균열량입니다. (자동 또는 수동 설정) |
| **전월/당월 열량단가** | 요금 계산에 사용되는 KRW/MJ 단위의 열량단가입니다. (자동 또는 수동 설정) |
| **온압보정계수** | 가스 부피 보정에 사용되는 계수입니다. (기본값: 1.0, 필요시 수정) |

#### 버튼 (Button)

| 엔티티 이름 | 설명 |
| :--- | :--- |
| **데이터 지금 동기화** | 버튼을 누르면 즉시 공급사 웹사이트에서 최신 데이터를 가져옵니다. |

#### 서비스 (Service)

| 서비스 이름 | 설명 |
| :--- | :--- |
| `city_gas_bill.update_data` | **'데이터 지금 동기화'** 버튼을 누르는 것과 동일한 작업을 수행합니다. 자동화(Automation)나 스크립트(Script)에서 이 서비스를 호출하여 원하는 시점에 데이터를 강제로 갱신할 수 있습니다. |

## 사용 가이드

### 데이터 동기화

-   데이터는 **매주 월요일 새벽 1시**에 자동으로 동기화됩니다.
-   즉시 동기화가 필요한 경우, **'데이터 지금 동기화'** 버튼을 누르거나 `city_gas_bill.update_data` 서비스를 호출하세요.

### 수동 입력 모드 사용법

1.  설정 시 공급사로 **'수동 입력 (직접 관리)'**를 선택합니다.
2.  엔티티가 생성되면, 본인의 가스 요금 고지서를 참고하여 아래 `Number` 엔티티들의 값을 직접 수정합니다.
    -   기본요금
    -   전월/당월 평균열량
    -   전월/당월 열량단가
    -   온압보정계수 (필요시)
3.  값을 수정한 후부터 정확한 요금이 계산됩니다. '데이터 동기화' 버튼은 수동 모드에서는 엔티티 값을 변경하지 않습니다.

### 청구 주기 리셋 로직

-   사용자가 설정한 **'월 정기 검침일'**이 되면, 통합구성요소는 자동으로 다음 작업을 수행합니다.
    1.  현재 `총 사용요금` 센서의 값을 `전월 총 사용요금` 센서로 이전합니다.
    2.  `월검침시작값` 엔티티의 값을 현재 가스 계량기 센서의 값으로 업데이트합니다.
    3.  `총 사용요금`과 `월 가스 사용량` 센서의 값이 0으로 초기화되며 새로운 주기의 계산이 시작됩니다.

## 새로운 공급사 추가하기 (고급)

이 통합구성요소는 새로운 도시가스 공급사를 쉽게 추가할 수 있도록 설계되었습니다.

1.  `custom_components/city_gas_bill/providers/` 폴더 안에 새로운 파이썬 파일(`busan_gas.py` 등)을 생성합니다.
2.  아래 템플릿에 따라 `GasProvider`를 상속받는 클래스를 작성하고, 스크래핑 로직을 구현합니다.
    ```python
    from .base import GasProvider
    # ... 필요한 import ...

    class BusanGasProvider(GasProvider):
        @property
        def id(self) -> str:
            return "busan_gas" # 파일 이름과 동일하게

        @property
        def name(self) -> str:
            return "부산도시가스" # UI에 표시될 이름

        async def scrape_heat_data(self) -> dict[str, float] | None:
            # 평균열량 스크래핑 로직 구현
            pass

        async def scrape_price_data(self) -> dict[str, float] | None:
            # 열량단가 스크래핑 로직 구현
            pass
    ```
3.  Home Assistant를 재시작하면, 설정 화면의 공급사 목록에 새로 추가한 프로바이더가 자동으로 나타납니다.

## 라이선스

이 프로젝트는 [MIT 라이선스](LICENSE)에 따라 배포됩니다.